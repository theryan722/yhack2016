<html>
    <head>
        <link rel="stylesheet" type="text/css" href="css/regularPages.css">
         <link href="https://fonts.googleapis.com/css?family=Open+Sans|Open+Sans+Condensed:300" rel="stylesheet">
        <style>
           
            body {
                 background-image: url("images/geometry.png");
                margin-top: 10%;
                font-size: 250%;
            }
            h1{
               color: #8FDBCD;
            }
            
            input[type="submit"] {
                border:1px solid #373737;
                font-size: 120%;
                background-color: #8FDBCD;
                color: white;
            }
            
            
        </style>
    </head>
    
    <body> 
      <script type="text/javascript">
        function getCookie(name) {
  				var value = "; " + document.cookie;
  				var parts = value.split("; " + name + "=");
  				if (parts.length == 2) return parts.pop().split(";").shift();
				}
        //{"email":"master@master.com","password":"master","name":"Master","address":"Payne Whitney Gymnasium, 70 Tower Pkwy, New Haven, CT 06511","balance":"1000","budget":"0","radius":"0"}
        function genList(listjson){
					var jsonarray = JSON.parse(listjson);
          var address = jsonarray['address'];
          var radius = jsonarray['radius'];
          
          httpGetAsync("http://yalecodeathon2016.000webhostapp.com/api/request.php?action=getlist&address="+address+"&radius="+radius, displayList);
        	httpGetAsync("http://yalecodeathon2016.000webhostapp.com/api/charity.php?action=getlist&address="+address+"&radius="+radius, displayCharity);
        }
        
        function displayList(dispjson){
          var feedhtml = "";
          var jsonarray = JSON.parse(dispjson);
        	for(var i = 0; i < jsonarray.length; i++) {
    				var items = jsonarray[i];
            
            feedhtml += "<b>Type of Job:</b> <span id=\"x\">"+items['type']+"</span> <br/><b>Description:</b> "+items['description']+"<br/>"+"<b>Address: </b>"+items['address']+"<br/><b>Price: </b>$"+items['price'] + 
              "<br/><input type=\"submit\" value=\"Fulfill\" id=\"s\" onclick='fulfillNow("+items['id']+","+items['price']+");'> <br/><br/>";
            
					}
          document.getElementById('feed').innerHTML = feedhtml;
         
        }
        
        function displayCharity(dispjson){
          var charityhtml = "";
          var jsonarray = JSON.parse(dispjson);
        	for(var i = 0; i < jsonarray.length; i++) {
    				var items = jsonarray[i];
            
            charityhtml += "<b>Title:</b> <span id=\"x\">"+items['title']+"</span> <br/><b>Description:</b> "+items['description']+"<br/>"+"<b>Address: </b>"+items['address']+"<br/><b>Price: </b>$"+items['price'] + 
              "<br/><input type=\"submit\" value=\"Fulfill\" id=\"s\" onclick='fulfillNow("+items['id'] +"," + items['price']+");'> <br/><br/>";
            
					}
          document.getElementById('charity').innerHTML = charityhtml;
         
        }
        
        
        function fulfillNow(rid, pr){
          httpGetAsync("http://yalecodeathon2016.000webhostapp.com/api/request.php?action=update&id="+rid+"&state=2", doNothing);
          httpGetAsync("http://yalecodeathon2016.000webhostapp.com/api/user.php?action=addbalance&email="+getCookie("email")+"&amount=" + pr, fulfilled);
          window.location.href="http://yalecodeathon2016.000webhostapp.com/app/profile.html";
          return false;
        }
        
        function doNothing(){
         //do nothing 
        }
        
        function fulfilled(){
            alert("You have chosen to fulfill this request!");
          	window.location.href="#";
          	return false;
        }
        
        function httpGetAsync(theUrl, callback) {
        	var xmlHttp = new XMLHttpRequest();
          xmlHttp.onreadystatechange = function() {
          if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
          	callback(xmlHttp.responseText);
        	}
          xmlHttp.open("GET", theUrl, true);
        	xmlHttp.send(null);
        }
        
        //yalecodeathon2016.000webhostapp.com/api/request.php?action=getlist&address=ADDRESS&radius=RADIUS
        
        var useremail;
        
        
            (function() {
              useremail = getCookie("email");
              httpGetAsync("http://yalecodeathon2016.000webhostapp.com/api/user.php?action=get&email=" + useremail, genList);
              
						})();        
                    
                    
      
                    
     </script>
      
      
        <h1> Fulfill</h1>
      
        <form>
          <h2>Jobs</h2>
          <div id="feed"><h3>Loading Data....</h3></div>
          <h2>Charity</h2>
          <div id="charity"><h3>Loading Data....</h3></div>
        </form>
        
    </body>
</html>
